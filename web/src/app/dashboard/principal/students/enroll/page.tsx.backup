'use client';

/**
 * Principal Direct Student Enrollment
 * Allows principals to manually add students without registration form
 * Use cases: Existing students, walk-ins, siblings, emergency enrollments
 */

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { PrincipalShell } from '@/components/dashboard/principal/PrincipalShell';
import { ArrowLeft, UserPlus } from 'lucide-react';

interface Class {
  id: string;
  name: string;
  grade_level: string;
  current_students: number;
  max_students: number;
}

interface Parent {
  id: string;
  email: string;
  first_name: string;
  last_name: string;
  phone?: string;
}

interface FormData {
  // Student Info
  first_name: string;
  last_name: string;
  date_of_birth: string;
  gender: string;
  id_number: string;
  
  // Academic
  class_id: string;
  status: string;
  enrollment_date: string;
  academic_year: string;
  
  // Contact
  home_address: string;
  home_phone: string;
  emergency_contact_name: string;
  emergency_contact_phone: string;
  emergency_contact_relationship: string;
  
  // Medical
  medical_conditions: string;
  allergies: string;
  medication: string;
  
  // Parent Linking (optional)
  parent_search: string;
  selected_parent_id: string;
  create_new_parent: boolean;
  new_parent_email: string;
  new_parent_first_name: string;
  new_parent_last_name: string;
  new_parent_phone: string;
  new_parent_relationship: string;
}

export default function EnrollStudentPage() {
  const router = useRouter();
  const supabase = createClientComponentClient();
  
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [preschoolId, setPreschoolId] = useState<string>('');
  const [organizationId, setOrganizationId] = useState<string>('');
  
  const [classes, setClasses] = useState<Class[]>([]);
  const [searchedParents, setSearchedParents] = useState<Parent[]>([]);
  const [searchingParents, setSearchingParents] = useState(false);
  
  const currentYear = new Date().getFullYear();
  
  const [formData, setFormData] = useState<FormData>({
    first_name: '',
    last_name: '',
    date_of_birth: '',
    gender: '',
    id_number: '',
    class_id: '',
    status: 'active',
    enrollment_date: new Date().toISOString().split('T')[0],
    academic_year: currentYear.toString(),
    home_address: '',
    home_phone: '',
    emergency_contact_name: '',
    emergency_contact_phone: '',
    emergency_contact_relationship: '',
    medical_conditions: '',
    allergies: '',
    medication: '',
    parent_search: '',
    selected_parent_id: '',
    create_new_parent: false,
    new_parent_email: '',
    new_parent_first_name: '',
    new_parent_last_name: '',
    new_parent_phone: '',
    new_parent_relationship: 'mother',
  });

  // Load principal's preschool info and classes
  useEffect(() => {
    const loadData = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        // Get principal's profile
        const { data: profile } = await supabase
          .from('profiles')
          .select('organization_id, preschool_id')
          .eq('id', user.id)
          .single();

        if (profile) {
          setOrganizationId(profile.organization_id);
          setPreschoolId(profile.preschool_id);

          // Load classes
          const { data: classesData } = await supabase
            .from('classes')
            .select('id, name, grade_level, current_students, max_students')
            .eq('preschool_id', profile.preschool_id)
            .eq('active', true)
            .order('grade_level');

          if (classesData) {
            setClasses(classesData);
          }
        }
      } catch (err) {
        console.error('Error loading data:', err);
        setError('Failed to load school data');
      }
    };

    loadData();
  }, [supabase]);

  // Search for existing parents
  const searchParents = async () => {
    if (!formData.parent_search.trim()) {
      setSearchedParents([]);
      return;
    }

    setSearchingParents(true);
    try {
      const searchTerm = formData.parent_search.toLowerCase();
      
      const { data, error: searchError } = await supabase
        .from('profiles')
        .select('id, email, first_name, last_name, phone')
        .eq('role', 'parent')
        .eq('organization_id', organizationId)
        .or(`email.ilike.%${searchTerm}%,first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%`)
        .limit(10);

      if (searchError) throw searchError;
      setSearchedParents(data || []);
    } catch (err) {
      console.error('Error searching parents:', err);
    } finally {
      setSearchingParents(false);
    }
  };

  // Generate student ID
  const generateStudentId = async (): Promise<string> => {
    try {
      // Get organization code
      const { data: org } = await supabase
        .from('organizations')
        .select('school_code, name')
        .eq('id', organizationId)
        .single();

      const orgCode = org?.school_code || 'EDU';
      const year = formData.academic_year.slice(-2); // Last 2 digits

      // Get count of students this year
      const { count } = await supabase
        .from('students')
        .select('id', { count: 'exact', head: true })
        .eq('organization_id', organizationId)
        .eq('academic_year', formData.academic_year);

      const nextNum = ((count || 0) + 1).toString().padStart(4, '0');
      return `${orgCode}-${year}-${nextNum}`;
    } catch (err) {
      console.error('Error generating student ID:', err);
      return `EDU-${formData.academic_year.slice(-2)}-${Date.now().toString().slice(-4)}`;
    }
  };

  // Submit enrollment
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      // Validation
      if (!formData.first_name || !formData.last_name || !formData.date_of_birth) {
        throw new Error('Please fill in all required fields');
      }

      if (!formData.class_id) {
        throw new Error('Please select a class');
      }

      // Generate student ID
      const studentId = await generateStudentId();

      // Create student record
      const { data: student, error: studentError } = await supabase
        .from('students')
        .insert({
          organization_id: organizationId,
          preschool_id: preschoolId,
          class_id: formData.class_id,
          student_id: studentId,
          first_name: formData.first_name.trim(),
          last_name: formData.last_name.trim(),
          date_of_birth: formData.date_of_birth,
          gender: formData.gender || null,
          id_number: formData.id_number || null,
          status: formData.status,
          enrollment_date: formData.enrollment_date,
          academic_year: formData.academic_year,
          home_address: formData.home_address || null,
          home_phone: formData.home_phone || null,
          emergency_contact_name: formData.emergency_contact_name || null,
          emergency_contact_phone: formData.emergency_contact_phone || null,
          emergency_contact_relationship: formData.emergency_contact_relationship || null,
          medical_conditions: formData.medical_conditions || null,
          allergies: formData.allergies || null,
          medication: formData.medication || null,
        })
        .select()
        .single();

      if (studentError) throw studentError;

      // Handle parent linking
      if (formData.create_new_parent && formData.new_parent_email) {
        // Create new parent account
        // Note: This requires admin privileges or invite system
        // For now, we'll just show a message
        setError('Parent account creation requires email invitation. Student created successfully. Send invitation to parent separately.');
      } else if (formData.selected_parent_id) {
        // Link to existing parent
        const { error: linkError } = await supabase
          .from('student_guardians')
          .insert({
            student_id: student.id,
            guardian_id: formData.selected_parent_id,
            relationship: formData.new_parent_relationship,
            primary_contact: true,
            can_pickup: true,
            financial_responsibility: true,
          });

        if (linkError) throw linkError;
      }

      // Update class enrollment count
      const { error: classUpdateError } = await supabase.rpc(
        'increment_class_enrollment',
        { class_uuid: formData.class_id }
      );

      if (classUpdateError) {
        console.error('Error updating class count:', classUpdateError);
        // Non-fatal, continue
      }

      setSuccess(true);
      setTimeout(() => {
        router.push('/dashboard/principal/students');
      }, 2000);

    } catch (err: any) {
      console.error('Enrollment error:', err);
      setError(err.message || 'Failed to enroll student');
    } finally {
      setLoading(false);
    }
  };

  return (
    <PrincipalShell>
      <div className="max-w-4xl mx-auto px-4 py-8">
        {/* Header */}
        <div className="mb-8">
          <button
            className="btn btnGhost"
            onClick={() => router.back()}
            style={{ marginBottom: 16 }}
          >
            <ArrowLeft size={18} style={{ marginRight: 8 }} />
            Back to Students
          </button>
          
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <UserPlus size={32} style={{ color: 'var(--primary)' }} />
            <div>
              <h1 className="h1" style={{ marginBottom: 4 }}>Enroll New Student</h1>
              <p style={{ fontSize: 14, color: 'var(--muted)' }}>Add a student directly without registration form</p>
            </div>
          </div>
        </div>

        {/* Error/Success Messages */}
        {error && (
          <div className="card" style={{ marginBottom: 24, padding: 16, backgroundColor: 'var(--error-bg, #fee)', borderColor: 'var(--error, #c00)' }}>
            <p style={{ color: 'var(--error, #c00)', margin: 0 }}>{error}</p>
          </div>
        )}
        
        {success && (
          <div className="card" style={{ marginBottom: 24, padding: 16, backgroundColor: 'var(--success-bg, #efe)', borderColor: 'var(--success, #0c0)' }}>
            <p style={{ color: 'var(--success, #0c0)', margin: 0 }}>✅ Student enrolled successfully! Redirecting...</p>
          </div>
        )}

        {/* Form */}
        <form onSubmit={handleSubmit} className="card">
          {/* Student Information */}
          <div style={{ padding: 24, borderBottom: '1px solid var(--border)' }}>
            <h2 style={{ fontSize: 18, fontWeight: 600, marginBottom: 16 }}>Student Information</h2>
            
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: 16 }}>
              <div>
                <label style={{ display: 'block', fontSize: 14, fontWeight: 500, marginBottom: 8 }}>
                  First Name *
                </label>
                <input
                  type="text"
                  value={formData.first_name}
                  onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                  required
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    border: '1px solid var(--border)',
                    borderRadius: 8,
                    fontSize: 14,
                  }}
                />
              </div>
              
              <div>
                <label style={{ display: 'block', fontSize: 14, fontWeight: 500, marginBottom: 8 }}>
                  Last Name *
                </label>
                <input
                  type="text"
                  value={formData.last_name}
                  onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                  required
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    border: '1px solid var(--border)',
                    borderRadius: 8,
                    fontSize: 14,
                  }}
                />
              </div>
              
              <div>
                <label style={{ display: 'block', fontSize: 14, fontWeight: 500, marginBottom: 8 }}>
                  Date of Birth *
                </label>
                <input
                  type="date"
                  value={formData.date_of_birth}
                  onChange={(e) => setFormData({ ...formData, date_of_birth: e.target.value })}
                  required
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    border: '1px solid var(--border)',
                    borderRadius: 8,
                    fontSize: 14,
                  }}
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Gender
                </label>
                <select
                  value={formData.gender}
                  onChange={(e) => setFormData({ ...formData, gender: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">Select gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
              </div>
              
              <Input
                label="ID Number"
                value={formData.id_number}
                onChange={(e) => setFormData({ ...formData, id_number: e.target.value })}
                placeholder="Optional"
              />
            </div>
          </div>

          {/* Academic Information */}
          <div className="p-6 border-b border-gray-200">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">Academic Details</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Class *
                </label>
                <select
                  value={formData.class_id}
                  onChange={(e) => setFormData({ ...formData, class_id: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  required
                >
                  <option value="">Select a class</option>
                  {classes.map((cls) => (
                    <option key={cls.id} value={cls.id}>
                      {cls.name} ({cls.current_students}/{cls.max_students} students)
                    </option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Status
                </label>
                <select
                  value={formData.status}
                  onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="registered">Registered</option>
                  <option value="active">Active</option>
                  <option value="enrolled">Enrolled</option>
                </select>
              </div>
              
              <Input
                type="date"
                label="Enrollment Date"
                value={formData.enrollment_date}
                onChange={(e) => setFormData({ ...formData, enrollment_date: e.target.value })}
              />
              
              <Input
                label="Academic Year"
                value={formData.academic_year}
                onChange={(e) => setFormData({ ...formData, academic_year: e.target.value })}
                placeholder={currentYear.toString()}
              />
            </div>
          </div>

          {/* Contact Information */}
          <div className="p-6 border-b border-gray-200">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">Contact & Emergency</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input
                label="Home Address"
                value={formData.home_address}
                onChange={(e) => setFormData({ ...formData, home_address: e.target.value })}
                placeholder="Optional"
              />
              
              <Input
                label="Home Phone"
                value={formData.home_phone}
                onChange={(e) => setFormData({ ...formData, home_phone: e.target.value })}
                placeholder="Optional"
              />
              
              <Input
                label="Emergency Contact Name"
                value={formData.emergency_contact_name}
                onChange={(e) => setFormData({ ...formData, emergency_contact_name: e.target.value })}
                placeholder="Optional"
              />
              
              <Input
                label="Emergency Contact Phone"
                value={formData.emergency_contact_phone}
                onChange={(e) => setFormData({ ...formData, emergency_contact_phone: e.target.value })}
                placeholder="Optional"
              />
              
              <Input
                label="Emergency Contact Relationship"
                value={formData.emergency_contact_relationship}
                onChange={(e) => setFormData({ ...formData, emergency_contact_relationship: e.target.value })}
                placeholder="e.g., Grandmother"
              />
            </div>
          </div>

          {/* Medical Information */}
          <div className="p-6 border-b border-gray-200">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">Medical Information</h2>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Medical Conditions
                </label>
                <textarea
                  value={formData.medical_conditions}
                  onChange={(e) => setFormData({ ...formData, medical_conditions: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  rows={2}
                  placeholder="Any medical conditions to be aware of..."
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Allergies
                </label>
                <textarea
                  value={formData.allergies}
                  onChange={(e) => setFormData({ ...formData, allergies: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  rows={2}
                  placeholder="Food allergies, medication allergies, etc."
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Current Medication
                </label>
                <textarea
                  value={formData.medication}
                  onChange={(e) => setFormData({ ...formData, medication: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  rows={2}
                  placeholder="Any regular medication..."
                />
              </div>
            </div>
          </div>

          {/* Parent/Guardian Linking */}
          <div className="p-6 border-b border-gray-200">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">Parent/Guardian (Optional)</h2>
            <p className="text-sm text-gray-600 mb-4">
              Search for an existing parent or skip to add later
            </p>
            
            <div className="space-y-4">
              <div>
                <Input
                  label="Search Parent by Email or Name"
                  value={formData.parent_search}
                  onChange={(e) => {
                    setFormData({ ...formData, parent_search: e.target.value });
                    searchParents();
                  }}
                  placeholder="Start typing to search..."
                />
                
                {searchingParents && (
                  <p className="text-sm text-gray-500 mt-2">Searching...</p>
                )}
                
                {searchedParents.length > 0 && (
                  <div className="mt-2 border border-gray-300 rounded-lg divide-y divide-gray-200 max-h-48 overflow-y-auto">
                    {searchedParents.map((parent) => (
                      <button
                        key={parent.id}
                        type="button"
                        onClick={() => {
                          setFormData({
                            ...formData,
                            selected_parent_id: parent.id,
                            parent_search: `${parent.first_name} ${parent.last_name} (${parent.email})`,
                          });
                          setSearchedParents([]);
                        }}
                        className="w-full text-left px-4 py-2 hover:bg-gray-50 transition-colors"
                      >
                        <div className="font-medium text-gray-900">
                          {parent.first_name} {parent.last_name}
                        </div>
                        <div className="text-sm text-gray-600">{parent.email}</div>
                        {parent.phone && (
                          <div className="text-sm text-gray-500">{parent.phone}</div>
                        )}
                      </button>
                    ))}
                  </div>
                )}
              </div>
              
              {formData.selected_parent_id && (
                <div className="bg-blue-50 border border-blue-200 px-4 py-3 rounded-lg">
                  <p className="text-sm text-blue-800">
                    ✓ Parent selected. Student will be linked after enrollment.
                  </p>
                  <button
                    type="button"
                    onClick={() => {
                      setFormData({ ...formData, selected_parent_id: '', parent_search: '' });
                    }}
                    className="text-sm text-blue-600 underline mt-1"
                  >
                    Clear selection
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Actions */}
          <div className="p-6 bg-gray-50 rounded-b-lg flex gap-4 justify-end">
            <Button
              type="button"
              variant="outline"
              onClick={() => router.back()}
              disabled={loading}
            >
              Cancel
            </Button>
            
            <Button
              type="submit"
              disabled={loading}
              className="min-w-[120px]"
            >
              {loading ? 'Enrolling...' : 'Enroll Student'}
            </Button>
          </div>
        </form>
      </div>
    </PrincipalShell>
  );
}
